name: H5Pack Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_android:
    # å‡è®¾ä½¿ç”¨é»˜è®¤çš„ Ubuntu Runner
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4
      
      # ç¡®ä¿ Node.js ç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼ˆ20æˆ–æ›´é«˜ï¼‰
      - name: 2. Setup Node.js 20+
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ä½¿ç”¨ 20 æˆ–æ›´é«˜ç‰ˆæœ¬

      - name: 3. Install project dependencies (npm/yarn/pnpm)
        # æ ¹æ®æ‚¨å®é™…ä½¿ç”¨çš„åŒ…ç®¡ç†å™¨é€‰æ‹©ï¼šnpm install æˆ– yarn install æˆ– pnpm install
        run: npm install 

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ ¸å¿ƒæ­¥éª¤ï¼šå®‰è£… PhantomJS ä¾èµ– ğŸ‘‡ğŸ‘‡ğŸ‘‡
      # è§£å†³ iconkits/phantomjs æŠ¥é”™çš„ "libproviders.so: cannot open shared object file"
      - name: 4. Install System Dependencies for phantomjs/iconkits
        run: |
          sudo apt-get update
          # è¿™äº›åº“é€šå¸¸èƒ½è§£å†³ PhantomJS åœ¨æ— å¤´ Linux ç¯å¢ƒä¸­çš„è¿è¡Œé—®é¢˜
          sudo apt-get install -y libfontconfig libicu67 libxi6 libxrender1 libxtst6
          
      # ğŸ‘†ğŸ‘†ğŸ‘† æ ¸å¿ƒæ­¥éª¤ï¼šå®‰è£… PhantomJS ä¾èµ– ğŸ‘†ğŸ‘†ğŸ‘†

      - name: 5. Run h5pack compress to build APK
        run: npm run compress
      
      # TODO: 6. æ·»åŠ ä¸€ä¸ªæ­¥éª¤æ¥ä¸Šä¼ ç”Ÿæˆçš„ APK æ–‡ä»¶åˆ° Artifacts
      # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ–¹ä¾¿æ‚¨ä¸‹è½½æ„å»ºæˆåŠŸçš„ APK æ–‡ä»¶ã€‚
      - name: 6. Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          # è¯·æ ¹æ® h5pack å®é™…è¾“å‡ºçš„è·¯å¾„å’Œæ–‡ä»¶åä¿®æ”¹è¿™é‡Œ
          path: android/app/build/outputs/apk/release/app-release.apk