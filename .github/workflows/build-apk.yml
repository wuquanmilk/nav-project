name: Build APK with h5pack

on:
push:
branches: ["main"]
workflow_dispatch:

jobs:
build-apk:
runs-on: ubuntu-latest

steps:
  - name: Checkout Code
    uses: actions/checkout@v4

  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: "20"

  # 修正了缩进以使其与其它步骤对齐
  - name: Install System Dependencies for Iconkits
    run: |
      sudo apt-get update
      sudo apt-get install -y libfontconfig libicu67 libxi6 libxrender1 libxtst6
      
  - name: Cache Node Modules
    uses: actions/cache@v3
    with:
      path: ~/.npm
      key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
      restore-keys: |
        ${{ runner.os }}-npm-

  - name: Install Dependencies
    run: npm install

  - name: Build Web Project
    run: npm run build

  - name: Build APK (npm run compress)
    run: npm run compress

  - name: Find APK File Path (Diagnosis)
    run: |
      echo "--- 正在查找所有 .apk 文件 ---"
      find . -name "*.apk"
      echo "-------------------------------"

  - name: Upload APK Artifact
    uses: actions/upload-artifact@v4
    with:
      name: nav-app-apk
      path: '**/*debug*.apk'
      retention-days: 5
